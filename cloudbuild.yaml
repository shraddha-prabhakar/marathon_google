steps:
  - name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "gcr.io/$PROJECT_ID/daily-tech", "."]

  - name: "gcr.io/cloud-builders/docker"
    args: ["push", "gcr.io/$PROJECT_ID/daily-tech"]

  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    args:
      - run
      - deploy
      - daily-tech
      - --image=gcr.io/$PROJECT_ID/daily-tech
      - --region=us-central1
      - --allow-unauthenticated
      - --set-env-vars=DB_USER=$(DB_USER)
      - --set-env-vars=DB_PASS=$(DB_PASS)
      - --set-env-vars=DB_NAME=$(DB_NAME)
      - --set-env-vars=DB_HOST=/cloudsql/$(INSTANCE_CONNECTION_NAME)
      - --set-env-vars=SMTP_USER=$(SMTP_USER)
      - --set-env-vars=SMTP_PASSWORD=$(SMTP_PASSWORD)
      - --add-cloudsql-instances=$(INSTANCE_CONNECTION_NAME)
